<!DOCTYPE html>
<html lang="en">

<!-- NGROK-SERVICE-SOIL -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant Watering Data - Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0f1419;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: #e0e0e0;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .demo-banner {
            background: rgba(255, 193, 7, 0.15);
            color: #FFC107;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid #FFC107;
        }

        .demo-banner.show {
            display: flex;
        }

        .demo-icon {
            font-size: 1.3em;
        }

        .controls {
            background: #1a1f26;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        label {
            font-weight: 600;
            color: #e0e0e0;
        }

        input[type="text"],
        input[type="number"],
        select {
            padding: 10px 15px;
            border: 2px solid #333;
            border-radius: 6px;
            font-size: 1em;
            background: #252a31;
            color: #e0e0e0;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #4CAF50;
        }

        button {
            padding: 10px 25px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(76, 175, 80, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .spacer {
            flex: 1;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            color: rgb(255, 255, 255);
            font-size: 0.9em;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .status-dot.loading {
            background: #ff9800;
            animation: pulse-slow 1s infinite;
        }

        @keyframes pulse-slow {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        .refresh-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #252a31;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #333;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
            color: #e0e0e0;
        }

        .refresh-toggle:hover {
            border-color: #4CAF50;
            background: #2a2f36;
        }

        .refresh-toggle.active {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .refresh-toggle.inactive {
            background: rgba(244, 67, 54, 0.1);
            border-color: #f44336;
            color: #f44336;
        }

        .refresh-icon {
            font-size: 1.1em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1f26;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            border: 2px solid #4CAF50;
        }

        .modal-header {
            font-size: 1.5em;
            font-weight: 600;
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            margin-bottom: 20px;
            border: 2px solid #333;
            border-radius: 6px;
            background: #252a31;
            color: #e0e0e0;
            font-size: 1em;
            box-sizing: border-box;
        }

        .modal-input:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: #4CAF50;
            color: white;
        }

        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
        }

        .modal-btn-secondary {
            background: #333;
            color: #e0e0e0;
        }

        .modal-btn-secondary:hover {
            background: #444;
        }

        .modal-output {
            background: #0f1419;
            border: 1px solid #333;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #4CAF50;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
        }

        .modal-output.show {
            display: block;
        }

        .modal-loading {
            text-align: center;
            color: #4CAF50;
            display: none;
            margin: 20px 0;
        }

        .modal-loading.show {
            display: block;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .manual-refresh-btn {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9em;
        }

        .manual-refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(76, 175, 80, 0.4);
        }

        .manual-refresh-btn:active {
            transform: translateY(0);
        }

        .manual-refresh-btn.refreshing {
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #1a1f26;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .stat-label {
            color: #999;
            font-size: 0.9em;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #4CAF50;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: #1a1f26;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #e0e0e0;
            margin-bottom: 20px;
        }

        .table-container {
            background: #1a1f26;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #252a31;
            color: #e0e0e0;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #252a31;
            color: #e0e0e0;
        }

        tbody tr:hover {
            background-color: #252a31;
        }

        .event-water {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .event-routine {
            background-color: #e3f2fd;
            color: #1565c0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .event-boot {
            background-color: #fff3e0;
            color: #e65100;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }

        .pagination {
            margin-top: 20px;
            text-align: center;
            padding: 20px;
        }

        .page-button {
            padding: 8px 12px;
            margin: 0 5px;
            background: #252a31;
            border: 2px solid #4CAF50;
            color: #4CAF50;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .page-button:hover {
            background: #4CAF50;
            color: white;
        }

        .page-button.active {
            background: #4CAF50;
            color: white;
        }

        .refresh-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .version-switch {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        .version-btn {
            background: #4CAF50;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9em;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .version-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .spacer {
                flex: none;
                width: 100%;
            }

            .status-indicator {
                width: 100%;
                justify-content: center;
            }

            .refresh-controls {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }

            .version-switch {
                position: static;
                margin-bottom: 20px;
                text-align: center;
            }
        }
    </style>
</head>

<body>

    <body>
        <div class="container">
            <header>
                <h1>üå± Plant Watering Data</h1>
                <p class="subtitle">Smart Soil Moisture Monitoring System by Veer Bajaj</p>
                <div class="demo-banner" id="demoBanner">
                    <span class="demo-icon">‚ö†Ô∏è</span>
                    <span>Showing demo data - live data file not found</span>
                </div>
            </header>

            <div class="controls">
                <div class="control-group">
                    <label for="rowsPerPage">Rows per page:</label>
                    <select id="rowsPerPage">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="eventFilter">Filter by event:</label>
                    <select id="eventFilter">
                        <option value="">All Events</option>
                        <option value="WATER_SMART_EVENT">Water Smart Event</option>
                        <option value="WATER_DUMB_EVENT">Water Dumb Event</option>
                        <option value="Routine Check">Routine Check</option>
                        <option value="SYSTEM_BOOT">System Boot</option>
                    </select>
                </div>
                <button onclick="resetFilters()">Reset Filters</button>
                <div class="spacer"></div>
                <div class="control-group">

                </div>
                <div class="control-group">
                    <label for="timeSlider">üïí Time Machine:</label>
                    <input type="range" id="timeSlider" min="0" max="1440" value="0" step="1" style="width: 200px;">
                    <span id="timeOffsetLabel" style="min-width: 80px; font-weight: bold; color: #4CAF50;">Live</span>
                </div>
                <button onclick="downloadData()" title="Download plant data as CSV">
                    üì• Download CSV
                </button>
                <div class="refresh-controls">
                    <div class="refresh-toggle active" id="refreshToggle" onclick="toggleAutoRefresh()"
                        title="Click to toggle auto-refresh">
                        <span class="refresh-icon">‚öôÔ∏è</span>
                        <span>Auto-Refresh ON</span>
                    </div>
                    <button class="manual-refresh-btn" id="manualRefreshBtn" onclick="manualRefresh()"
                        title="Refresh data now">
                        üîÑ Refresh
                    </button>
                    <button class="manual-refresh-btn" id="testSensorBtn" onclick="openTestSensorModal()"
                        title="Test sensor data">
                        üß™ Test Sensors
                    </button>
                </div>
                <div class="control-group">
                    <label for="chartLibrary">üìä Chart Mode:</label>
                    <select id="chartLibrary">
                        <option value="chartjs">Regular</option>
                        <option value="plotly">Advanced</option>
                    </select>
                </div>
                <div class="spacer"></div>
                <div class="control-group">
                    <label for="rowsPerPage">Rows per page:</label>
                    <select id="rowsPerPage">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
                <div class="status-indicator">
                    <span class="status-dot" id="statusDot"></span>
                    <div>
                        <div>Live</div>
                        <div id="lastUpdate" style="font-size: 0.85em; opacity: 0.8;">Loading...</div>
                    </div>
                </div>
            </div>

            <div class="stats-grid" id="statsGrid">
                <div class="stat-card">
                    <div class="stat-label">Total Records</div>
                    <div class="stat-value" id="totalRecords">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Water Events</div>
                    <div class="stat-value" id="waterEvents">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Smart Moisture</div>
                    <div class="stat-value" id="avgSmartMoisture">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg Dumb Moisture</div>
                    <div class="stat-value" id="avgDumbMoisture">0%</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Smart vs Dumb Moisture Over Time</div>
                    <div id="moistureChartPlotly" style="height: 400px; width: 100%; display: none;"></div>
                    <canvas id="moistureChartJS"></canvas>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Event Distribution</div>
                    <div id="eventChartPlotly" style="height: 400px; width: 100%; display: none;"></div>
                    <canvas id="eventChartJS"></canvas>
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Timestamp</th>
                            <th>Smart Moisture</th>
                            <th>Dumb Moisture</th>
                            <th>Event</th>
                            <th>Reason</th>
                            <th>Water Used (L)</th>
                        </tr>
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
                <div class="pagination" id="pagination"></div>
            </div>
        </div>

        <!-- Test Sensor Modal -->
        <div class="modal" id="testSensorModal">
            <div class="modal-content">
                <div class="modal-header">üß™ Test Sensor Data</div>
                <input type="password" class="modal-input" id="testPasscodeInput" placeholder="Enter passcode"
                    onkeypress="if(event.key==='Enter') runTestSensor()">
                <div class="modal-loading" id="testLoading">
                    <div class="spinner"></div>
                    <div>Running test...</div>
                </div>
                <div class="modal-output" id="testOutput"></div>
                <div class="modal-buttons">
                    <button class="modal-btn modal-btn-secondary" onclick="closeTestSensorModal()">Cancel</button>
                    <button class="modal-btn modal-btn-primary" onclick="runTestSensor()">Run Test</button>
                </div>
            </div>
        </div>

        <script>
            let allData = [];
            let filteredData = [];
            let currentPage = 1;
            let rowsPerPage = 25;
            let moistureChart = null;
            let eventChart = null;
            let isDemoData = false;
            let refreshInterval = null;
            let autoRefreshEnabled = true;
            let timeOffsetMinutes = 0;
            let chartLibrary = 'chartjs';

            function parseDate(dateStr) {
                // Converts "YYYY-MM-DD HH:MM:SS" to a Date object
                if (!dateStr) return new Date(0);
                return new Date(dateStr.replace(' ', 'T'));
            }

            // Fetch and parse CSV
            async function loadData() {
                try {
                    const dataSource = 'live';
                    let response;

                    if (dataSource === 'none') {
                        response = await fetch('./main/out/archive-demo/plant_data.csv');
                        isDemoData = true;
                        document.getElementById('demoBanner').classList.add('show');
                    } else {
                        response = await fetch('./main/out/plant_data.csv');
                        isDemoData = false;
                        document.getElementById('demoBanner').classList.remove('show');
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const text = await response.text();
                    parseCSV(text);

                    applyFilters();
                    updateLastRefreshTime();
                    setStatusDotReady();
                } catch (error) {
                    console.error('Error loading data:', error);
                    document.getElementById('tableBody').innerHTML = '<tr><td colspan="6">Error loading data. Check that the CSV files exist in ./main/out/ or ./main/out/archive-demo/</td></tr>';
                    setStatusDotError();
                }
            }

            function parseCSV(text) {
                const lines = text.trim().split('\n');
                if (lines.length < 2) {
                    console.error('CSV is empty or malformed');
                    return;
                }

                allData = [];
                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    if (values.length < 4) continue;

                    const timeStr = values[0];
                    const timestamp = parseDate(timeStr).getTime();

                    allData.push({
                        timestamp: timeStr,
                        timestampMs: timestamp,
                        smartMoisture: parseFloat(values[1]),
                        dumbMoisture: parseFloat(values[2]),
                        event: values[3],
                        reason: values[4],
                        waterUsed: values[5]
                    });
                }

                // Update Time Machine slider range based on data
                if (allData.length > 1) {
                    const earliest = allData[0].timestampMs;
                    const latest = allData[allData.length - 1].timestampMs;
                    const totalMinutes = Math.floor((latest - earliest) / (60 * 1000));

                    const slider = document.getElementById('timeSlider');
                    slider.max = Math.max(totalMinutes, 1440); // At least 24h or more if data spans further
                }

                filteredData = [...allData];
            }

            function updateStats() {
                const smartMoistures = filteredData.map(d => d.smartMoisture).filter(v => !isNaN(v));
                const dumbMoistures = filteredData.map(d => d.dumbMoisture).filter(v => !isNaN(v));
                const waterEvents = filteredData.filter(d => d.event.includes('WATER')).length;

                document.getElementById('totalRecords').textContent = filteredData.length;
                document.getElementById('waterEvents').textContent = waterEvents;
                document.getElementById('avgSmartMoisture').textContent =
                    smartMoistures.length > 0 ? (smartMoistures.reduce((a, b) => a + b, 0) / smartMoistures.length).toFixed(1) + '%' : '0%';
                document.getElementById('avgDumbMoisture').textContent =
                    dumbMoistures.length > 0 ? (dumbMoistures.reduce((a, b) => a + b, 0) / dumbMoistures.length).toFixed(1) + '%' : '0%';
            }

            function createCharts() {
                if (filteredData.length === 0) return;

                const library = document.getElementById('chartLibrary').value;
                const plotlyMoisture = document.getElementById('moistureChartPlotly');
                const plotlyEvent = document.getElementById('eventChartPlotly');
                const classicMoisture = document.getElementById('moistureChartJS');
                const classicEvent = document.getElementById('eventChartJS');

                if (library === 'plotly') {
                    plotlyMoisture.style.display = 'block';
                    plotlyEvent.style.display = 'block';
                    classicMoisture.style.display = 'none';
                    classicEvent.style.display = 'none';
                    createPlotlyCharts();
                } else {
                    plotlyMoisture.style.display = 'none';
                    plotlyEvent.style.display = 'none';
                    classicMoisture.style.display = 'block';
                    classicEvent.style.display = 'block';
                    createChartJSCharts();
                }
            }

            function createPlotlyCharts() {
                const sampleSize = Math.max(1, Math.floor(filteredData.length / 100));
                const sampledData = filteredData.filter((_, i) => i % sampleSize === 0);

                const traceSmart = {
                    x: sampledData.map(d => d.timestamp),
                    y: sampledData.map(d => d.smartMoisture),
                    name: 'Smart Sensor',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#667eea', width: 3, shape: 'spline' },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(102, 126, 234, 0.1)',
                    hovertemplate: '<b>%{x}</b><br>Smart: %{y:.2f}%<extra></extra>'
                };

                const traceDumb = {
                    x: sampledData.map(d => d.timestamp),
                    y: sampledData.map(d => d.dumbMoisture),
                    name: 'Dumb Sensor',
                    type: 'scatter',
                    mode: 'lines',
                    line: { color: '#764ba2', width: 3, shape: 'spline' },
                    fill: 'tozeroy',
                    fillcolor: 'rgba(118, 75, 162, 0.1)',
                    hovertemplate: '<b>%{x}</b><br>Dumb: %{y:.2f}%<extra></extra>'
                };

                const layoutMoisture = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#e0e0e0', family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif' },
                    margin: { t: 40, b: 40, l: 50, r: 20 },
                    xaxis: { gridcolor: '#252a31', linecolor: '#252a31', title: 'Time' },
                    yaxis: { gridcolor: '#252a31', linecolor: '#252a31', range: [0, 100], ticksuffix: '%', title: 'Moisture Level' },
                    legend: { orientation: 'h', y: 1.1, x: 0.5, xanchor: 'center' },
                    hovermode: 'x unified'
                };

                Plotly.newPlot('moistureChartPlotly', [traceSmart, traceDumb], layoutMoisture, { responsive: true, displayModeBar: false });

                const eventCounts = {};
                filteredData.forEach(d => { eventCounts[d.event] = (eventCounts[d.event] || 0) + 1; });

                const traceEvent = {
                    labels: Object.keys(eventCounts),
                    values: Object.values(eventCounts),
                    type: 'pie',
                    hole: 0.4,
                    marker: {
                        colors: ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#4CAF50', '#FFC107'],
                        line: { color: '#1a1f26', width: 2 }
                    },
                    textinfo: 'percent'
                };

                const layoutEvent = {
                    paper_bgcolor: 'rgba(0,0,0,0)',
                    plot_bgcolor: 'rgba(0,0,0,0)',
                    font: { color: '#e0e0e0', family: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif' },
                    margin: { t: 20, b: 20, l: 20, r: 20 },
                    showlegend: true,
                    legend: { orientation: 'h', y: -0.1, x: 0.5, xanchor: 'center' }
                };

                Plotly.newPlot('eventChartPlotly', [traceEvent], layoutEvent, { responsive: true, displayModeBar: false });
            }

            function createChartJSCharts() {
                if (filteredData.length === 0) return;

                // Moisture Chart - show samples to avoid overcrowding
                const sampleSize = Math.max(1, Math.floor(filteredData.length / 100));
                const sampledData = filteredData.filter((_, i) => i % sampleSize === 0);

                const moistureCtx = document.getElementById('moistureChartJS').getContext('2d');
                if (moistureChart) moistureChart.destroy();

                moistureChart = new Chart(moistureCtx, {
                    type: 'line',
                    data: {
                        labels: sampledData.map(d => d.timestamp.split(' ')[1]),
                        datasets: [
                            {
                                label: 'Smart Sensor',
                                data: sampledData.map(d => d.smartMoisture),
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true
                            },
                            {
                                label: 'Dumb Sensor',
                                data: sampledData.map(d => d.dumbMoisture),
                                borderColor: '#764ba2',
                                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                                tension: 0.4,
                                fill: true
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top', labels: { color: '#e0e0e0' } }
                        },
                        scales: {
                            x: { grid: { color: '#252a31' }, ticks: { color: '#999' } },
                            y: {
                                grid: { color: '#252a31' },
                                ticks: { color: '#999', callback: (v) => v + '%' },
                                min: 0,
                                max: 100
                            }
                        }
                    }
                });

                // Event Distribution Chart
                const eventCounts = {};
                filteredData.forEach(d => {
                    eventCounts[d.event] = (eventCounts[d.event] || 0) + 1;
                });

                const eventCtx = document.getElementById('eventChartJS').getContext('2d');
                if (eventChart) eventChart.destroy();

                eventChart = new Chart(eventCtx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(eventCounts),
                        datasets: [{
                            data: Object.values(eventCounts),
                            backgroundColor: [
                                '#667eea', '#764ba2', '#f093fb', '#4facfe', '#4CAF50', '#FFC107'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#e0e0e0' } }
                        },
                        cutout: '70%'
                    }
                });
            }

            function applyFilters() {
                if (allData.length === 0) return;

                const eventFilter = document.getElementById('eventFilter').value;
                const sliderValue = parseInt(document.getElementById('timeSlider').value);
                timeOffsetMinutes = sliderValue;

                const latestDataPoint = allData[allData.length - 1];
                const latestTimeMs = latestDataPoint.timestampMs;
                const cutoffTimeMs = latestTimeMs - (timeOffsetMinutes * 60 * 1000);

                // Update label
                const label = document.getElementById('timeOffsetLabel');
                if (timeOffsetMinutes === 0) {
                    label.textContent = 'Live';
                    label.style.color = '#4CAF50';
                } else {
                    label.textContent = `-${timeOffsetMinutes}m`;
                    label.style.color = '#FFC107';
                }

                filteredData = allData.filter(row => {
                    // Primary filter: Time Scrollback (only show data up to cutoff)
                    if (row.timestampMs > cutoffTimeMs) {
                        return false;
                    }

                    // Secondary filter: Event Type
                    if (eventFilter && !row.event.includes(eventFilter)) {
                        return false;
                    }

                    return true;
                });

                currentPage = 1;
                updateStats();
                createCharts();
                displayTable();

                // Update simulated "Live" time in the UI
                const lastUpdateElem = document.getElementById('lastUpdate');
                if (timeOffsetMinutes > 0) {
                    lastUpdateElem.textContent = new Date(cutoffTimeMs).toLocaleTimeString() + ' (Simulated)';
                } else {
                    lastUpdateElem.textContent = new Date(latestTimeMs).toLocaleTimeString();
                }
            }

            function resetFilters() {
                document.getElementById('eventFilter').value = '';
                document.getElementById('timeSlider').value = 0;
                applyFilters();
            }

            function displayTable() {
                const start = (currentPage - 1) * rowsPerPage;
                const end = start + rowsPerPage;
                const pageData = filteredData.slice(start, end);

                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = pageData.map(row => `
                <tr>
                    <td>${row.timestamp}</td>
                    <td><strong>${row.smartMoisture.toFixed(2)}</strong></td>
                    <td><strong>${row.dumbMoisture.toFixed(2)}</strong></td>
                    <td><span class="event-${getEventClass(row.event)}">${row.event}</span></td>
                    <td>${row.reason || '-'}</td>
                    <td>${row.waterUsed || '-'}</td>
                </tr>
            `).join('');

                updatePagination();
            }

            function getEventClass(event) {
                if (event.includes('WATER')) return 'water';
                if (event.includes('BOOT')) return 'boot';
                return 'routine';
            }

            function updatePagination() {
                const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                const pagination = document.getElementById('pagination');

                let html = '';
                for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                    html += `<button class="page-button ${i === currentPage ? 'active' : ''}" 
                    onclick="goToPage(${i})">${i}</button>`;
                }

                pagination.innerHTML = html;
            }

            function goToPage(page) {
                currentPage = page;
                displayTable();
                window.scrollTo(0, 0);
            }

            function downloadData() {
                if (allData.length === 0) {
                    alert('No data available to download');
                    return;
                }

                // Create CSV content
                const headers = ['Timestamp', 'Smart Moisture', 'Dumb Moisture', 'Event', 'Reason', 'Water Used (L)'];
                const rows = allData.map(d => [
                    d.timestamp,
                    d.smartMoisture.toFixed(2),
                    d.dumbMoisture.toFixed(2),
                    d.event,
                    d.reason || '',
                    d.waterUsed || ''
                ]);

                const csv = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
                ].join('\n');

                // Create blob and download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                link.setAttribute('href', url);
                link.setAttribute('download', `plant_data_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';

                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function updateLastRefreshTime() {
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
            }

            function setStatusDotReady() {
                const dot = document.getElementById('statusDot');
                dot.classList.remove('loading');
                dot.style.background = '#4CAF50';
            }

            function setStatusDotLoading() {
                const dot = document.getElementById('statusDot');
                dot.classList.add('loading');
                dot.style.background = '#ff9800';
            }

            function setStatusDotError() {
                const dot = document.getElementById('statusDot');
                dot.classList.remove('loading');
                dot.style.background = '#f44336';
            }

            function toggleAutoRefresh() {
                autoRefreshEnabled = !autoRefreshEnabled;
                const toggle = document.getElementById('refreshToggle');

                if (autoRefreshEnabled) {
                    toggle.classList.remove('inactive');
                    toggle.classList.add('active');
                    toggle.innerHTML = '<span class="refresh-icon">‚öôÔ∏è</span><span>Auto-Refresh ON</span>';
                    startAutoRefresh();
                } else {
                    toggle.classList.remove('active');
                    toggle.classList.add('inactive');
                    toggle.innerHTML = '<span class="refresh-icon">‚è∏Ô∏è</span><span>Auto-Refresh OFF</span>';
                    if (refreshInterval) {
                        clearInterval(refreshInterval);
                        refreshInterval = null;
                    }
                }
            }

            function manualRefresh() {
                const btn = document.getElementById('manualRefreshBtn');
                btn.classList.add('refreshing');
                setStatusDotLoading();

                loadData().then(() => {
                    btn.classList.remove('refreshing');
                    setStatusDotReady();
                }).catch(() => {
                    btn.classList.remove('refreshing');
                    setStatusDotError();
                });
            }

            // Event listeners
            document.getElementById('rowsPerPage').addEventListener('change', (e) => {
                rowsPerPage = parseInt(e.target.value);
                currentPage = 1;
                displayTable();
            });

            document.getElementById('eventFilter').addEventListener('change', applyFilters);

            // Refresh every 10 seconds
            function startAutoRefresh() {
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(() => {
                    setStatusDotLoading();
                    loadData();
                }, 10000);
            }

            // Load data on page load
            loadData();
            startAutoRefresh();

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (refreshInterval) clearInterval(refreshInterval);
            });

            document.getElementById('dataSource').addEventListener('change', () => {
                currentPage = 1;
                loadData();
            });

            document.getElementById('chartLibrary').addEventListener('change', createCharts);
            document.getElementById('timeSlider').addEventListener('input', applyFilters);

            // Test Sensor Modal Functions
            function openTestSensorModal() {
                const modal = document.getElementById('testSensorModal');
                modal.classList.add('show');
                document.getElementById('testPasscodeInput').focus();
                document.getElementById('testPasscodeInput').value = '';
                document.getElementById('testOutput').classList.remove('show');
                document.getElementById('testLoading').classList.remove('show');
            }

            function closeTestSensorModal() {
                const modal = document.getElementById('testSensorModal');
                modal.classList.remove('show');
            }

            async function runTestSensor() {
                const passcode = document.getElementById('testPasscodeInput').value;
                const output = document.getElementById('testOutput');
                const loading = document.getElementById('testLoading');

                if (!passcode) {
                    alert('Please enter the passcode');
                    return;
                }

                loading.classList.add('show');
                output.classList.remove('show');

                try {
                    const response = await fetch(`/api/test-sensors?passcode=${encodeURIComponent(passcode)}`);
                    const data = await response.json();

                    loading.classList.remove('show');

                    if (data.success) {
                        output.textContent = data.output;
                        output.classList.add('show');
                    } else {
                        output.textContent = `Error: ${data.error}`;
                        output.classList.add('show');
                    }
                } catch (error) {
                    loading.classList.remove('show');
                    output.textContent = `Connection Error: ${error.message}`;
                    output.classList.add('show');
                }
            }

            // Close modal when clicking outside
            window.addEventListener('click', (e) => {
                const modal = document.getElementById('testSensorModal');
                if (e.target === modal) {
                    closeTestSensorModal();
                }
            });
        </script>
    </body>

</html>